# ë©”ì‹œì§€ íë¦„ ìƒì„¸ ê°€ì´ë“œ

## ğŸ¯ í•µì‹¬ íë¦„: ìœ ì € A â†’ ìœ ì € B ë©”ì‹œì§€ ì „ì†¡

### ì „ì²´ íë¦„ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     1. ë©”ì‹œì§€ ì „ì†¡                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
            [ìœ ì € A í´ë¼ì´ì–¸íŠ¸ - iOS/Android]
                            â†“
            {"type":"CHAT", "chatRoomId":"A_B",
             "senderId":"A", "content":"ì•ˆë…•í•˜ì„¸ìš”"}
                            â†“
                    WebSocket SEND
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  2. ì„œë²„ ìˆ˜ì‹  & ì €ì¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
            [ChatWebSocketHandler.handleChatMessage]
                            â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â†“                   â†“
         chatService.saveMessage()  (ë³‘ë ¬ ì²˜ë¦¬)
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    MongoDB     â”‚
         â”‚ chat_messages  â”‚
         â”‚                â”‚
         â”‚ {              â”‚
         â”‚   id: "msg123" â”‚
         â”‚   chatRoomId   â”‚
         â”‚   senderId: A  â”‚
         â”‚   content      â”‚
         â”‚   timestamp    â”‚
         â”‚ }              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
              ì €ì¥ ì™„ë£Œ
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               3. ìˆ˜ì‹ ì ì˜¨ë¼ì¸ ì²´í¬                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
    chatService.getChatRoom(chatRoomId)
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    MongoDB     â”‚
         â”‚  chat_rooms    â”‚
         â”‚                â”‚
         â”‚ {              â”‚
         â”‚   id: "A_B"    â”‚
         â”‚   user1Id: A   â”‚
         â”‚   user2Id: B   â”‚â† ìˆ˜ì‹ ì í™•ì¸
         â”‚ }              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
      receiverId = chatRoom.getOtherUserId("A")
      receiverId = "B"
                  â†“
      sessions.get("B")  // WebSocket ì„¸ì…˜ í™•ì¸
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                 â†“
    ì„¸ì…˜ ì¡´ì¬?          ì„¸ì…˜ ì—†ìŒ?
    (ì˜¨ë¼ì¸)            (ì˜¤í”„ë¼ì¸)
         â”‚                 â”‚
         â”‚                 â†“
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚ 4-A. í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡    â”‚
         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â†“
         â”‚    sendPushNotification(B, message)
         â”‚                 â†“
         â”‚         ë©”ì¸ ë°±ì—”ë“œ API í˜¸ì¶œ
         â”‚         ë˜ëŠ” FCM/APNs ì§ì ‘ í˜¸ì¶œ
         â”‚                 â†“
         â”‚         [ìœ ì € B ìŠ¤ë§ˆíŠ¸í°]
         â”‚         ğŸ“± ì•Œë¦¼ ë„ì°©!
         â”‚         "Aë‹˜: ì•ˆë…•í•˜ì„¸ìš”"
         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            4-B. Redis Publish (í™•ì¥ ëŒ€ë¹„)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
      chatService.publishMessage(chatRoomId, message)
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     Redis      â”‚
         â”‚   Pub/Sub      â”‚
         â”‚                â”‚
         â”‚ PUBLISH        â”‚
         â”‚ "chat:A_B"     â”‚
         â”‚ {message...}   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
        ëª¨ë“  ì„œë²„ì— ë¸Œë¡œë“œìºìŠ¤íŠ¸
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          5. Redis Subscribe & ë©”ì‹œì§€ í¬ì›Œë”©                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
    [RedisMessageSubscriber.handleRedisMessage]
                  â†“
         chatService.getChatRoom(chatRoomId)
                  â†“
         receiverId = "B"
                  â†“
         sessions.get("B")
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                 â†“
    ì„¸ì…˜ ì¡´ì¬?          ì„¸ì…˜ ì—†ìŒ?
    (ì´ ì„œë²„ì— ì—°ê²°)    (ë‹¤ë¥¸ ì„œë²„ ë˜ëŠ” ì˜¤í”„ë¼ì¸)
         â”‚                 â”‚
         â†“                 â””â†’ ë¬´ì‹œ (ì´ë¯¸ ì•Œë¦¼ ë³´ëƒ„)
    sendToSession(sessionId, message)
         â†“
    sessionSinks.get(sessionId)
         â†“
    sink.tryEmitNext(message)
         â†“
    [Reactive Stream ìë™ ì²˜ë¦¬]
         â†“
    objectMapper.writeValueAsString(message)
         â†“
    {"type":"CHAT","id":"msg123",...}
         â†“
    session.textMessage(json)
         â†“
    WebSocketìœ¼ë¡œ ì „ì†¡
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  6. í´ë¼ì´ì–¸íŠ¸ ìˆ˜ì‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
         [ìœ ì € B í´ë¼ì´ì–¸íŠ¸]
                  â†“
         WebSocket RECEIVE
                  â†“
         JSON íŒŒì‹±
                  â†“
    {"type":"CHAT","content":"ì•ˆë…•í•˜ì„¸ìš”",...}
                  â†“
         UI ì—…ë°ì´íŠ¸
                  â†“
         ğŸ’¬ í™”ë©´ì— í‘œì‹œ
         "A: ì•ˆë…•í•˜ì„¸ìš”"
```

---

## ğŸ“± Optimistic UI (ë°œì‹ ì í™”ë©´)

```
[ìœ ì € A í´ë¼ì´ì–¸íŠ¸]
      â†“ ë©”ì‹œì§€ ì…ë ¥
      â†“ "ì•ˆë…•í•˜ì„¸ìš”"
      â†“ ì „ì†¡ ë²„íŠ¼ í´ë¦­
      â†“
      â†“ âš¡ ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ (0.1ì´ˆ)
      â†“ ìƒíƒœ: ì „ì†¡ ì¤‘ â³
      â†“
      â†“ ë°±ê·¸ë¼ìš´ë“œë¡œ WebSocket ì „ì†¡
      â†“
      â†“ ... ì„œë²„ ì²˜ë¦¬ ì¤‘ (1ì´ˆ) ...
      â†“
      â†“ ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ 
      â†“
      â”œâ”€ ì„±ê³µ? â†’ ìƒíƒœ: ì „ì†¡ ì™„ë£Œ âœ“âœ“
      â””â”€ ì‹¤íŒ¨? â†’ ìƒíƒœ: ì „ì†¡ ì‹¤íŒ¨ âš ï¸ (ì¬ì „ì†¡ ë²„íŠ¼)
```

---

## ğŸ” ê° ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…

### 1ë‹¨ê³„: MongoDB ì €ì¥

**ì™œ ë¨¼ì € ì €ì¥í•˜ëŠ”ê°€?**
- âœ… ë©”ì‹œì§€ ìœ ì‹¤ ë°©ì§€
- âœ… ì„œë²„ í¬ë˜ì‹œ ì‹œì—ë„ DBì— ë‚¨ìŒ
- âœ… ê³ ìœ  ID ìƒì„± (MongoDB ObjectId)
- âœ… íˆìŠ¤í† ë¦¬ ì¡°íšŒ ê°€ëŠ¥

**ì €ì¥ ì‹œê°„:** 1~5ms (MongoDBëŠ” ë¹ ë¦„!)

---

### 2ë‹¨ê³„: ì˜¨ë¼ì¸ ì²´í¬

**ë‹¨ì¼ ì„œë²„ í™˜ê²½ (í˜„ì¬):**
```java
Map<String, WebSocketSession> sessions;
WebSocketSession session = sessions.get(receiverId);

if (session != null && session.isOpen()) {
    // ì˜¨ë¼ì¸
} else {
    // ì˜¤í”„ë¼ì¸ â†’ í‘¸ì‹œ ì•Œë¦¼
}
```

**ì™œ sessions Mapìœ¼ë¡œ ì¶©ë¶„í•œê°€?**
- ëª¨ë“  WebSocket ì—°ê²°ì´ ì´ ì„œë²„ì— ìˆìŒ
- Mapì— ì—†ìœ¼ë©´ = ì§„ì§œ ì˜¤í”„ë¼ì¸
- ì¶”ê°€ ì¸í”„ë¼ ë¶ˆí•„ìš”

---

### 3ë‹¨ê³„: í‘¸ì‹œ ì•Œë¦¼ (ì˜¤í”„ë¼ì¸ ì‹œ)

**íƒ€ì´ë°:**
- Redis Publish **ì „ì—** ì•Œë¦¼ ì „ì†¡
- ì™œ? ì˜¤í”„ë¼ì¸ì´ë©´ Redis ë©”ì‹œì§€ ëª» ë°›ìŒ

**êµ¬í˜„ ë°©ë²• (TODO):**
```java
private void sendPushNotification(String userId, WebSocketMessage message) {
    // ë°©ë²• 1: ë©”ì¸ ë°±ì—”ë“œ API í˜¸ì¶œ
    webClient.post()
        .uri("http://spring-api:8080/api/notifications/push")
        .bodyValue(PushNotificationRequest.builder()
            .userId(userId)
            .title(message.getSenderName())
            .body(message.getContent())
            .data(Map.of(
                "chatRoomId", message.getChatRoomId(),
                "messageId", message.getId()
            ))
            .build())
        .retrieve()
        .bodyToMono(Void.class)
        .subscribe();
    
    // ë°©ë²• 2: FCM/APNs ì§ì ‘ í˜¸ì¶œ
    // FirebaseMessaging.getInstance().send(...)
}
```

---

### 4ë‹¨ê³„: Redis Publish

**ë‹¨ì¼ ì„œë²„ì—ì„œë„ Publishí•˜ëŠ” ì´ìœ :**
1. **êµ¬ì¡°ì  ì¼ê´€ì„±**: í–¥í›„ í™•ì¥ ì‹œ ì½”ë“œ ë³€ê²½ ì—†ìŒ
2. **í…ŒìŠ¤íŠ¸ ìš©ì´**: ë‹¤ì¤‘ ì„œë²„ í™˜ê²½ ë¯¸ë¦¬ ê²€ì¦
3. **ë¶€ì‘ìš© ì—†ìŒ**: ë°œì‹ ìë§Œ subscribe ì¤‘ì´ë¯€ë¡œ ë¬´ì‹œë¨

**ë°œì‹ ìëŠ” ìê¸° ë©”ì‹œì§€ ì•ˆ ë°›ìŒ:**
```java
// handleRedisMessageì—ì„œ
if (receiverId.equals(senderId)) {
    return; // ë°œì‹ ìëŠ” ê±´ë„ˆëœ€
}
```

---

### 5ë‹¨ê³„: WebSocket í¬ì›Œë”©

**Reactive Stream ë§ˆë²•:**
```java
// WebSocket ì—°ê²° ì‹œ ì„¤ì •
Mono<Void> output = session.send(
    sink.asFlux()  // â† Sinkë¥¼ Fluxë¡œ ë³€í™˜
        .map(msg -> session.textMessage(
            objectMapper.writeValueAsString(msg)
        ))
);

// ë‚˜ì¤‘ì— ì–¸ì œë“ ì§€
sink.tryEmitNext(message);  // â† ìë™ìœ¼ë¡œ ì „ì†¡ë¨!
```

**ë¹„ìœ :**
- Sink = ì»¨ë² ì´ì–´ ë²¨íŠ¸
- output = ë²¨íŠ¸ë¥¼ ì§€ì¼œë³´ëŠ” ë¡œë´‡
- ë©”ì‹œì§€ ë„£ìœ¼ë©´ â†’ ë¡œë´‡ì´ ìë™ìœ¼ë¡œ í¬ì¥ â†’ ë°°ì†¡

---

## ğŸš¦ ì‹œë‚˜ë¦¬ì˜¤ë³„ íë¦„

### ì‹œë‚˜ë¦¬ì˜¤ 1: ë‘˜ ë‹¤ ì˜¨ë¼ì¸

```
ìœ ì € A (ì˜¨ë¼ì¸) â†’ ë©”ì‹œì§€ ì „ì†¡
  â†“
ì„œë²„: MongoDB ì €ì¥
  â†“
ì„œë²„: sessions.get(B) â†’ ì¡´ì¬ âœ…
  â†“
ì„œë²„: Redis Publish
  â†“
ì„œë²„: handleRedisMessage
  â†“
ì„œë²„: sessions.get(B) â†’ ì¡´ì¬ âœ…
  â†“
ì„œë²„: WebSocket í¬ì›Œë”©
  â†“
ìœ ì € B (ì˜¨ë¼ì¸) â†’ ë©”ì‹œì§€ ìˆ˜ì‹  ğŸ’¬
```

**ê²°ê³¼:** 
- âœ… í‘¸ì‹œ ì•Œë¦¼ ì•ˆ ë³´ëƒ„ (ì˜¨ë¼ì¸ì´ë¯€ë¡œ)
- âœ… ì¦‰ì‹œ ë©”ì‹œì§€ ì „ë‹¬
- âš¡ ì§€ì—°: ~50ms

---

### ì‹œë‚˜ë¦¬ì˜¤ 2: ìˆ˜ì‹ ì ì˜¤í”„ë¼ì¸

```
ìœ ì € A (ì˜¨ë¼ì¸) â†’ ë©”ì‹œì§€ ì „ì†¡
  â†“
ì„œë²„: MongoDB ì €ì¥
  â†“
ì„œë²„: sessions.get(B) â†’ ì—†ìŒ âŒ
  â†“
ì„œë²„: ğŸ“± í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
  â†“ (ë³‘ë ¬ë¡œ)
ì„œë²„: Redis Publish
  â†“
ì„œë²„: handleRedisMessage
  â†“
ì„œë²„: sessions.get(B) â†’ ì—†ìŒ âŒ
  â†“
ì„œë²„: ë¬´ì‹œ (ì´ë¯¸ ì•Œë¦¼ ë³´ëƒ„)
```

**ê²°ê³¼:**
- âœ… í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ë¨
- âœ… ë©”ì‹œì§€ëŠ” MongoDBì— ì €ì¥ë¨
- âœ… Bê°€ ë‚˜ì¤‘ì— ì•± ì¼œë©´ íˆìŠ¤í† ë¦¬ì—ì„œ ë³¼ ìˆ˜ ìˆìŒ

---

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë°œì‹ ì ë³¸ì¸

```
ìœ ì € A â†’ ë©”ì‹œì§€ ì „ì†¡
  â†“
í´ë¼ì´ì–¸íŠ¸: Optimistic UI âš¡
  â†’ ì¦‰ì‹œ í™”ë©´ì— "ì•ˆë…•í•˜ì„¸ìš”" í‘œì‹œ
  â†“
ì„œë²„: MongoDB ì €ì¥
  â†“
ì„œë²„: Redis Publish
  â†“
ì„œë²„: handleRedisMessage
  â†“
ì„œë²„: receiverId = B (Aê°€ ì•„ë‹˜)
  â†“
ì„œë²„: AëŠ” ì²˜ë¦¬ ì•ˆ í•¨ âœ…
```

**ê²°ê³¼:**
- âœ… ë°œì‹ ìëŠ” Optimistic UIë¡œ ì¦‰ì‹œ ë´„
- âœ… ì„œë²„ì—ì„œ ì¬ì „ì†¡ ì•ˆ í•¨
- âš¡ UX: ì¦‰ê° ë°˜ì‘

---

## â±ï¸ ì„±ëŠ¥ ì§€í‘œ

### ë©”ì‹œì§€ ì „ì†¡ ì§€ì—°

| ë‹¨ê³„ | ì†Œìš” ì‹œê°„ | ëˆ„ì  |
|------|----------|------|
| í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ | ~10ms | 10ms |
| MongoDB ì €ì¥ | ~5ms | 15ms |
| ì˜¨ë¼ì¸ ì²´í¬ | <1ms | 16ms |
| Redis Publish | ~2ms | 18ms |
| Redis Subscribe | ~2ms | 20ms |
| WebSocket í¬ì›Œë”© | ~5ms | 25ms |
| ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ | ~10ms | 35ms |

**ì´ ì§€ì—°: ~35ms** âš¡

---

## ğŸ”„ í™•ì¥ ì‹œ ë³€ê²½ì‚¬í•­

### ë‹¤ì¤‘ ì„œë²„ í™˜ê²½

```
ìœ ì € A (ì„œë²„1) â†’ ë©”ì‹œì§€ ì „ì†¡
  â†“
ì„œë²„1: MongoDB ì €ì¥
  â†“
ì„œë²„1: sessions.get(B) â†’ ì—†ìŒ (ì„œë²„2ì— ì—°ê²°)
  â†“
ì„œë²„1: í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡? 
  â†’ âŒ ì ê¹! Bê°€ ì„œë²„2ì— ìˆì„ ìˆ˜ë„!
  â†“
ì„œë²„1: Redis Publish
  â†“
ì„œë²„1, ì„œë²„2, ì„œë²„3 ëª¨ë‘ ìˆ˜ì‹ 
  â†“
ì„œë²„2: sessions.get(B) â†’ ìˆìŒ! âœ…
  â†“
ì„œë²„2: WebSocket í¬ì›Œë”©
  â†“
ìœ ì € B (ì„œë²„2) â†’ ë©”ì‹œì§€ ìˆ˜ì‹ 
```

**í•„ìš”í•œ ë³€ê²½:**
```java
// PresenceService í™œìš©
if (session == null) {
    // ë¡œì»¬ì— ì—†ìŒ â†’ Redis í™•ì¸
    presenceService.isOnline(B)
        .subscribe(isOnline -> {
            if (!isOnline) {
                // ëª¨ë“  ì„œë²„ì— ì—†ìŒ â†’ í‘¸ì‹œ
                sendPushNotification(B, message);
            }
        });
}
```

---

## âœ… í•µì‹¬ í¬ì¸íŠ¸

1. **ì €ì¥ ë¨¼ì €**: ë©”ì‹œì§€ ìœ ì‹¤ ë°©ì§€
2. **ì˜¨ë¼ì¸ ì²´í¬**: í‘¸ì‹œ ì•Œë¦¼ ê²°ì •
3. **ì•Œë¦¼ ë¨¼ì €, Pub ë‚˜ì¤‘**: ì˜¤í”„ë¼ì¸ë„ ë°›ê²Œ
4. **ë°œì‹ ì ì œì™¸**: Optimistic UI í™œìš©
5. **RedisëŠ” í™•ì¥ ëŒ€ë¹„**: í˜„ì¬ëŠ” ë³´ë„ˆìŠ¤

ì´ íë¦„ì´ ì±„íŒ… ì‹œìŠ¤í…œì˜ í•µì‹¬ì…ë‹ˆë‹¤! ğŸ¯
